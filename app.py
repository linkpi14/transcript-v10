import streamlit as st
import os
import tempfile
import uuid
import time
from pathlib import Path
import requests
import base64
import re
import io
from pydub import AudioSegment

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Transcri√ß√£o de V√≠deos",
    page_icon="üé¨",
    layout="centered",
    initial_sidebar_state="collapsed"
)

# T√≠tulo e descri√ß√£o
st.title("üé¨ Transcri√ß√£o de V√≠deos")
st.markdown("""
Este aplicativo permite transcrever o conte√∫do de √°udio de v√≠deos para texto usando a API do OpenAI Whisper.
Voc√™ pode fazer upload de um arquivo ou fornecer um link do YouTube/Instagram (requer download manual).
""")

# Fun√ß√£o para criar diret√≥rio tempor√°rio
@st.cache_resource
def get_temp_dir():
    temp_dir = tempfile.mkdtemp()
    return temp_dir

# Fun√ß√£o para converter arquivo para MP3 usando pydub
def convert_to_mp3(input_file, output_file=None):
    try:
        # Se output_file n√£o for especificado, cria um nome baseado no input
        if output_file is None:
            output_file = os.path.splitext(input_file)[0] + ".mp3"
        
        # Carregar o arquivo de √°udio/v√≠deo
        audio = AudioSegment.from_file(input_file)
        
        # Exportar como MP3
        audio.export(output_file, format="mp3")
        
        return {
            'success': True,
            'file_path': output_file,
            'message': 'Arquivo convertido com sucesso para MP3'
        }
    except Exception as e:
        return {
            'success': False,
            'error': str(e),
            'message': f'Erro ao converter arquivo para MP3: {str(e)}'
        }

# Fun√ß√£o para transcrever √°udio usando a API do OpenAI
def transcribe_with_openai_api(audio_file_path, api_key, language=None):
    try:
        # URL da API do OpenAI para transcri√ß√£o
        url = "https://api.openai.com/v1/audio/transcriptions"
        
        # Cabe√ßalhos da requisi√ß√£o
        headers = {
            "Authorization": f"Bearer {api_key}"
        }
        
        # Par√¢metros da requisi√ß√£o
        data = {
            "model": "whisper-1",
        }
        
        # Adicionar idioma se especificado
        if language and language != "":
            data["language"] = language
        
        # Abrir o arquivo de √°udio
        with open(audio_file_path, "rb") as f:
            # Enviar a requisi√ß√£o para a API
            files = {
                "file": (os.path.basename(audio_file_path), f, "audio/mpeg")
            }
            
            response = requests.post(url, headers=headers, data=data, files=files)
        
        # Verificar se a requisi√ß√£o foi bem-sucedida
        if response.status_code == 200:
            result = response.json()
            return {
                'success': True,
                'text': result.get("text", ""),
                'language': language or "detectado automaticamente",
                'message': 'Transcri√ß√£o conclu√≠da com sucesso'
            }
        else:
            error_message = f"Erro na API: {response.status_code} - {response.text}"
            return {
                'success': False,
                'error': error_message,
                'message': error_message
            }
            
    except Exception as e:
        return {
            'success': False,
            'error': str(e),
            'message': f'Erro ao transcrever √°udio: {str(e)}'
        }

# Inicializar o diret√≥rio tempor√°rio
temp_dir = get_temp_dir()

# Criar abas para diferentes m√©todos de entrada
tab1, tab2, tab3, tab4 = st.tabs(["Upload de Arquivo", "YouTube (Manual)", "Instagram (Manual)", "Configura√ß√µes"])

# Lista de idiomas suportados
languages = {
    "": "Detectar automaticamente",
    "pt": "Portugu√™s",
    "en": "Ingl√™s",
    "es": "Espanhol",
    "fr": "Franc√™s",
    "de": "Alem√£o",
    "it": "Italiano",
    "ja": "Japon√™s",
    "zh": "Chin√™s",
    "ru": "Russo"
}

# Formatos suportados pela API do Whisper
supported_formats = ['flac', 'm4a', 'mp3', 'mp4', 'mpeg', 'mpga', 'oga', 'ogg', 'wav', 'webm']

# Formatos que podemos tentar converter
convertible_formats = ['mp4', 'avi', 'mov', 'mkv', 'webm', 'flv', 'wmv', 'm4v']

# Todos os formatos aceitos para upload
all_accepted_formats = list(set(supported_formats + convertible_formats))

# Aba de Upload de Arquivo
with tab1:
    st.header("Upload de Arquivo")
    
    # Verificar se a chave API est√° configurada
    api_key = st.session_state.get("openai_api_key", "")
    
    if not api_key:
        st.warning("‚ö†Ô∏è Chave API da OpenAI n√£o configurada. Por favor, v√° para a aba 'Configura√ß√µes' para adicionar sua chave API.")
    
    st.info(f"Formatos suportados diretamente: {', '.join(supported_formats)}")
    st.info(f"Formatos que ser√£o convertidos automaticamente: {', '.join(convertible_formats)}")
    
    uploaded_file = st.file_uploader("Escolha um arquivo de √°udio ou v√≠deo", type=all_accepted_formats)
    language_upload = st.selectbox("Idioma (opcional)", options=list(languages.keys()), format_func=lambda x: languages[x], key="language_upload")
    
    if uploaded_file is not None and api_key:
        if st.button("Transcrever Arquivo", key="btn_upload"):
            # Salvar o arquivo temporariamente
            with st.spinner("Processando o arquivo..."):
                # Criar um arquivo tempor√°rio
                temp_file = os.path.join(temp_dir, uploaded_file.name)
                with open(temp_file, "wb") as f:
                    f.write(uploaded_file.getbuffer())
                
                # Verificar se o formato √© suportado diretamente pela API
                file_ext = os.path.splitext(temp_file)[1].lower().replace('.', '')
                
                # Se n√£o for um formato suportado diretamente, tentar converter para MP3
                if file_ext not in supported_formats:
                    st.info(f"Convertendo arquivo de {file_ext} para MP3...")
                    
                    # Converter para MP3
                    mp3_file = os.path.splitext(temp_file)[0] + ".mp3"
                    conversion_result = convert_to_mp3(temp_file, mp3_file)
                    
                    if not conversion_result['success']:
                        st.error(f"Erro ao converter arquivo: {conversion_result.get('message', 'Falha na convers√£o')}")
                        # Limpar o arquivo tempor√°rio
                        try:
                            os.remove(temp_file)
                        except:
                            pass
                        st.stop()
                    
                    # Usar o arquivo MP3 convertido
                    temp_file = mp3_file
                    st.success("Arquivo convertido com sucesso para MP3!")
                
                # Transcrever o √°udio usando a API da OpenAI
                with st.spinner("Transcrevendo o √°udio..."):
                    result = transcribe_with_openai_api(temp_file, api_key, language_upload if language_upload else None)
                
                # Limpar os arquivos tempor√°rios
                try:
                    os.remove(temp_file)
                    # Se houver um arquivo original diferente do convertido, remover tamb√©m
                    if file_ext not in supported_formats:
                        original_file = os.path.join(temp_dir, uploaded_file.name)
                        if os.path.exists(original_file):
                            os.remove(original_file)
                except:
                    pass
                
                # Exibir o resultado
                if result['success']:
                    st.success("Transcri√ß√£o conclu√≠da com sucesso!")
                    st.subheader("Texto Transcrito:")
                    st.text_area("", value=result['text'], height=300, key="text_upload")
                    
                    # Op√ß√µes para download
                    st.download_button(
                        label="Download TXT",
                        data=result['text'],
                        file_name="transcricao.txt",
                        mime="text/plain"
                    )
                else:
                    st.error(f"Erro: {result.get('message', 'Falha na transcri√ß√£o')}")

# Aba do YouTube
with tab2:
    st.header("YouTube (Download Manual)")
    
    st.info("Devido a restri√ß√µes de autentica√ß√£o, voc√™ precisa baixar o v√≠deo manualmente e depois fazer upload.")
    
    # Instru√ß√µes para baixar v√≠deos do YouTube
    st.subheader("Como baixar v√≠deos do YouTube:")
    st.markdown("""
    1. Copie o link do v√≠deo do YouTube
    2. Acesse um dos sites abaixo:
       - [y2mate.com](https://www.y2mate.com/)
       - [savefrom.net](https://en.savefrom.net/)
    3. Cole o link e baixe o v√≠deo em formato MP3 ou MP4
    4. Volte para a aba "Upload de Arquivo" e fa√ßa upload do arquivo baixado
    """)
    
    # Campo para o link do YouTube (apenas para refer√™ncia)
    youtube_url = st.text_input("Link do YouTube (apenas para refer√™ncia)", key="youtube_url")
    
    if youtube_url:
        # Valida√ß√£o b√°sica da URL
        if "youtube.com" in youtube_url or "youtu.be" in youtube_url:
            st.success("Link do YouTube v√°lido! Siga as instru√ß√µes acima para baixar o v√≠deo.")
            
            # Extrair o ID do v√≠deo para exibir uma miniatura
            youtube_id = None
            if "youtube.com" in youtube_url and "v=" in youtube_url:
                youtube_id = youtube_url.split("v=")[1].split("&")[0]
            elif "youtu.be" in youtube_url:
                youtube_id = youtube_url.split("/")[-1].split("?")[0]
            
            if youtube_id:
                st.image(f"https://img.youtube.com/vi/{youtube_id}/0.jpg", caption="Miniatura do v√≠deo")
        else:
            st.error("URL inv√°lida do YouTube")

# Aba do Instagram
with tab3:
    st.header("Instagram (Download Manual)")
    
    st.info("Devido a restri√ß√µes de autentica√ß√£o, voc√™ precisa baixar o v√≠deo manualmente e depois fazer upload.")
    
    # Instru√ß√µes para baixar v√≠deos do Instagram
    st.subheader("Como baixar v√≠deos do Instagram:")
    st.markdown("""
    1. Copie o link do v√≠deo/reels do Instagram
    2. Use um dos m√©todos abaixo:
       - Aplicativos: "Video Downloader for Instagram", "Reels Downloader"
       - Sites: [inflact.com](https://inflact.com/downloader/instagram/), [snapinsta.app](https://snapinsta.app/)
    3. Baixe o v√≠deo em formato MP4
    4. Volte para a aba "Upload de Arquivo" e fa√ßa upload do arquivo baixado
    """)
    
    # Campo para o link do Instagram (apenas para refer√™ncia)
    instagram_url = st.text_input("Link do Instagram (apenas para refer√™ncia)", key="instagram_url")
    
    if instagram_url:
        # Valida√ß√£o b√°sica da URL
        if "instagram.com" in instagram_url:
            st.success("Link do Instagram v√°lido! Siga as instru√ß√µes acima para baixar o v√≠deo.")
        else:
            st.error("URL inv√°lida do Instagram")

# Aba de Configura√ß√µes
with tab4:
    st.header("Configura√ß√µes")
    
    st.subheader("Chave API da OpenAI")
    
    # Campo para a chave API
    api_key_input = st.text_input(
        "Insira sua chave API da OpenAI",
        value=st.session_state.get("openai_api_key", ""),
        type="password",
        help="Voc√™ pode obter uma chave API em https://platform.openai.com/api-keys"
    )
    
    if st.button("Salvar Chave API"):
        st.session_state["openai_api_key"] = api_key_input
        st.success("Chave API salva com sucesso!")
    
    st.markdown("---")
    
    st.subheader("Como obter uma chave API da OpenAI")
    st.markdown("""
    1. Acesse [platform.openai.com](https://platform.openai.com/)
    2. Crie uma conta ou fa√ßa login
    3. V√° para "API Keys" no menu
    4. Clique em "Create new secret key"
    5. D√™ um nome para sua chave e clique em "Create"
    6. Copie a chave e cole no campo acima
    
    **Nota**: A OpenAI oferece cr√©ditos gratuitos para novos usu√°rios, mas depois disso, o servi√ßo √© pago. Consulte a [p√°gina de pre√ßos](https://openai.com/pricing) para mais informa√ß√µes.
    """)
    
    st.markdown("---")
    
    st.subheader("Sobre a convers√£o autom√°tica de formatos")
    st.markdown("""
    Este aplicativo agora converte automaticamente formatos de v√≠deo comuns para MP3 antes de envi√°-los para a API do Whisper.
    
    **Formatos suportados para convers√£o autom√°tica:**
    - MP4, AVI, MOV, MKV, WEBM, FLV, WMV, M4V
    
    Se voc√™ encontrar problemas com algum formato espec√≠fico, tente converter manualmente para MP3 usando sites como:
    - [Online-convert.com](https://www.online-convert.com/)
    - [Convertio](https://convertio.co/)
    """)

# Informa√ß√µes adicionais
st.markdown("---")
st.markdown("""
### Notas:
- Este aplicativo usa a API do OpenAI Whisper para transcri√ß√£o
- Voc√™ precisa fornecer sua pr√≥pria chave API da OpenAI
- O tamanho m√°ximo do arquivo √© limitado pelo Streamlit (200MB)
- A qualidade da transcri√ß√£o varia conforme a clareza do √°udio
""")

# Rodap√©
st.markdown("---")
st.caption("Aplicativo de Transcri√ß√£o de V√≠deos | Desenvolvido com Streamlit")
